<script>
    /**
     * –î–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π Telegram —Å–∫—Ä–∏–ø—Ç —Å –£–°–ò–õ–ï–ù–ù–´–ú –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º –∏ –∑–∞–ø–∏—Å—å—é tilda_order_id
     * –†–ê–ó–ú–ï–©–ï–ù–ò–ï: –í FOOTER —Å–∞–π—Ç–∞ (–ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º </body>)
     */

    console.log('[TELEGRAM] –î–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å —É—Å–∏–ª–µ–Ω–Ω—ã–º –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º –∑–∞–≥—Ä—É–∂–µ–Ω');

    const TELEGRAM_BOT_TOKEN = '8111231642:AAE6FjAyI5B_zMcokXQ1KPpSU7ZZ2S76DXI';
    const TELEGRAM_CHAT_ID = '481014845';

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö)
    function logToLocalStorage(message) {
        try {
            const logs = JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]');
            const timestamp = new Date().toISOString();
            logs.push(`${timestamp}: ${message}`);

            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π
            if (logs.length > 100) {
                logs.splice(0, logs.length - 100);
            }

            localStorage.setItem('telegram_debug_logs', JSON.stringify(logs));
            console.log('[TELEGRAM DEBUG]', message);
        } catch (error) {
            console.log('[TELEGRAM DEBUG ERROR]', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ base64 –≤ Blob
    function base64ToBlob(base64Data, contentType = '') {
        const byteCharacters = atob(base64Data.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);

        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: contentType });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Ñ–æ—Ä–º
    function getCustomerData() {
        const customerData = {
            name: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            email: '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
            phone: '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
        };

        logToLocalStorage('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞');

        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º
        const nameSelectors = [
            'input[name="name"]',
            'input[name="Name"]',
            'input[name="firstname"]',
            'input[name="FirstName"]',
            'input[placeholder*="–∏–º—è"]',
            'input[placeholder*="–ò–º—è"]',
            'input[data-tilda-rule="name"]',
            'input[data-field="name"]',
            '.js-tilda-rule input[data-tilda-rule="name"]',
            '.t-input[data-tilda-rule="name"]'
        ];

        const emailSelectors = [
            'input[name="email"]',
            'input[name="Email"]',
            'input[type="email"]',
            'input[data-tilda-rule="email"]',
            'input[data-field="email"]',
            '.js-tilda-rule input[data-tilda-rule="email"]',
            '.t-input[data-tilda-rule="email"]'
        ];

        const phoneSelectors = [
            'input[name="phone"]',
            'input[name="Phone"]',
            'input[name="tel"]',
            'input[type="tel"]',
            'input[data-tilda-rule="phone"]',
            'input[data-field="phone"]',
            '.js-tilda-rule input[data-tilda-rule="phone"]',
            '.t-input[data-tilda-rule="phone"]'
        ];

        // –ü–æ–∏—Å–∫ –∏–º–µ–Ω–∏
        for (const selector of nameSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.name = element.value.trim();
                logToLocalStorage(`–ò–º—è –Ω–∞–π–¥–µ–Ω–æ: ${customerData.name} —á–µ—Ä–µ–∑ ${selector}`);
                break;
            }
        }

        // –ü–æ–∏—Å–∫ email
        for (const selector of emailSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.email = element.value.trim();
                logToLocalStorage(`Email –Ω–∞–π–¥–µ–Ω: ${customerData.email} —á–µ—Ä–µ–∑ ${selector}`);
                break;
            }
        }

        // –ü–æ–∏—Å–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        for (const selector of phoneSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.phone = element.value.trim();
                logToLocalStorage(`–¢–µ–ª–µ—Ñ–æ–Ω –Ω–∞–π–¥–µ–Ω: ${customerData.phone} —á–µ—Ä–µ–∑ ${selector}`);
                break;
            }
        }

        // –ü–æ–∏—Å–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ ST100
        const cartForm = document.querySelector('.js-store-cart-form, .js-cart-form');
        if (cartForm) {
            logToLocalStorage('–ù–∞–π–¥–µ–Ω–∞ —Ñ–æ—Ä–º–∞ –∫–æ—Ä–∑–∏–Ω—ã ST100');

            const cartNameField = cartForm.querySelector('input[name="name"], input[data-tilda-rule="name"]');
            const cartEmailField = cartForm.querySelector('input[name="email"], input[data-tilda-rule="email"]');
            const cartPhoneField = cartForm.querySelector('input[name="phone"], input[data-tilda-rule="phone"]');

            if (cartNameField && cartNameField.value && cartNameField.value.trim()) {
                customerData.name = cartNameField.value.trim();
                logToLocalStorage(`–ò–º—è –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã: ${customerData.name}`);
            }
            if (cartEmailField && cartEmailField.value && cartEmailField.value.trim()) {
                customerData.email = cartEmailField.value.trim();
                logToLocalStorage(`Email –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã: ${customerData.email}`);
            }
            if (cartPhoneField && cartPhoneField.value && cartPhoneField.value.trim()) {
                customerData.phone = cartPhoneField.value.trim();
                logToLocalStorage(`–¢–µ–ª–µ—Ñ–æ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã: ${customerData.phone}`);
            }
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        try {
            const savedCustomerData = localStorage.getItem('tilda_customer_data');
            if (savedCustomerData) {
                const parsed = JSON.parse(savedCustomerData);
                if (parsed.name && parsed.name !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ') customerData.name = parsed.name;
                if (parsed.email && parsed.email !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ') customerData.email = parsed.email;
                if (parsed.phone && parsed.phone !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ') customerData.phone = parsed.phone;
                logToLocalStorage(`–î–∞–Ω–Ω—ã–µ –∏–∑ localStorage: ${JSON.stringify(parsed)}`);
            }
        } catch (error) {
            logToLocalStorage(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage: ${error.message}`);
        }

        logToLocalStorage(`–ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞: ${JSON.stringify(customerData)}`);
        return customerData;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ –∏–∑ localStorage
    function getOrderNumber() {
        const savedOrderId = localStorage.getItem('tilda_order_id');
        if (savedOrderId) {
            logToLocalStorage(`–ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${savedOrderId}`);
            return savedOrderId;
        }

        logToLocalStorage('–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return '';
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ IndexedDB
    async function getCurrentOrderProducts() {
        if (!window.TildaCartDB) {
            logToLocalStorage('TildaCartDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            return [];
        }

        try {
            const db = new TildaCartDB();
            await db.init();
            const allProducts = await db.getAllProducts();

            logToLocalStorage(`–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ IndexedDB: ${allProducts.length}`);

            // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
            const orderTime = localStorage.getItem('order_created_time');
            if (!orderTime) {
                logToLocalStorage('–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞, –±–µ—Ä–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã');
                return allProducts;
            }

            const orderTimestamp = parseInt(orderTime);
            const timeThreshold = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ)
            const currentProducts = allProducts.filter(product => {
                if (!product.timestamp) return true; // –ï—Å–ª–∏ –Ω–µ—Ç timestamp, –≤–∫–ª—é—á–∞–µ–º
                const timeDiff = Math.abs(orderTimestamp - product.timestamp);
                return timeDiff < timeThreshold;
            });

            logToLocalStorage(`–¢–æ–≤–∞—Ä–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞: ${currentProducts.length}`);
            return currentProducts;

        } catch (error) {
            logToLocalStorage(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤: ${error.message}`);
            return [];
        }
    }

    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –≤ Telegram (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
    async function sendOrderToTelegram() {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        if (window.telegramSending) {
            logToLocalStorage('‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–∫–∞ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            return false;
        }

        window.telegramSending = true;

        try {
            logToLocalStorage('–ù–ê–ß–ò–ù–ê–ï–ú –û–¢–ü–†–ê–í–ö–£ –ó–ê–ö–ê–ó–ê –í TELEGRAM');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —É–∂–µ
            const alreadySent = localStorage.getItem('telegram_sent');
            if (alreadySent) {
                logToLocalStorage('–ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–Ω–µ–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                return false;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
            const customer = getCustomerData();

            // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
            const orderNumber = getOrderNumber();

            let message = '–ù–û–í–´–ô –ó–ê–ö–ê–ó - –û–ñ–ò–î–ê–ï–ú –û–ü–õ–ê–¢–£!\n\n';

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (orderNumber) {
                message += `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${orderNumber}\n\n`;
            }

            message += `–ö–ª–∏–µ–Ω—Ç: ${customer.name}\n`;
            message += `Email: ${customer.email}\n`;
            message += `–¢–µ–ª–µ—Ñ–æ–Ω: ${customer.phone}\n`;
            message += `–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}\n\n`;

            let files = [];
            let totalAmount = 0;

            // –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
            const products = await getCurrentOrderProducts();

            if (products.length > 0) {
                message += `–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ:\n`;
                products.forEach((product, i) => {
                    message += `\n${i + 1}. ${product.productName || '–¢–æ–≤–∞—Ä'}\n`;
                    if (product.text) {
                        message += `–¢–µ–∫—Å—Ç: ${product.text}\n`;
                    }
                    message += `SKU: ${product.sku || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n`;
                    message += `–ö–æ–ª-–≤–æ: 1\n`;

                    // –£–õ–£–ß–®–ï–ù–ù–û–ï –ø–æ–ª—É—á–µ–Ω–∏–µ —Ü–µ–Ω—ã
                    let productPrice = '0';

                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –¶–µ–Ω–∞ –∏–∑ –ø—Ä–æ–¥—É–∫—Ç–∞
                    if (product.price && product.price.toString().trim()) {
                        productPrice = product.price.toString();
                    }
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –¶–µ–Ω–∞ –∏–∑ API –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞)
                    else {
                        const savedApiPrice = localStorage.getItem('last_api_price');
                        if (savedApiPrice) {
                            productPrice = savedApiPrice;
                            logToLocalStorage(`–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∏–∑ API: ${productPrice}`);
                        }
                    }

                    message += `–¶–µ–Ω–∞: ${productPrice} –†–£–ë\n`;

                    // –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–µ–π —Å—É–º–º–µ
                    const priceNumber = parseFloat(productPrice.toString().replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
                    totalAmount += priceNumber;

                    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    if (product.file && product.file.data) {
                        const blob = base64ToBlob(product.file.data, product.file.type);
                        files.push({
                            name: product.file.name || 'file.jpg',
                            blob: blob,
                            productName: product.productName || '–¢–æ–≤–∞—Ä'
                        });
                        message += `–ö —Ç–æ–≤–∞—Ä—É –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Ñ–∞–π–ª\n`;
                    }
                });

                if (files.length > 0) {
                    message += `\n–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${files.length}\n`;
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –æ–±—â—É—é —Å—É–º–º—É
                message += `\n–û–±—â–∞—è —Å—É–º–º–∞: ${totalAmount} –†–£–ë\n`;
                message += `–°–¢–ê–¢–£–°: –û–ñ–ò–î–ê–ï–ú –û–ü–õ–ê–¢–£\n`;

                logToLocalStorage(`–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—É–º–º–∞: ${totalAmount}`);

            } else {
                message += `–¢–æ–≤–∞—Ä—ã: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –≤ IndexedDB\n`;
                logToLocalStorage('–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ IndexedDB');
            }

            try {
                logToLocalStorage('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram');

                // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message
                    })
                });

                const result = await response.json();
                if (!result.ok) {
                    logToLocalStorage(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${result.description}`);
                    return false;
                }

                logToLocalStorage('–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');

                // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
                if (files.length > 0) {
                    logToLocalStorage(`–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${files.length} —Ñ–∞–π–ª–æ–≤`);

                    for (let fileObj of files) {
                        const formData = new FormData();
                        formData.append('chat_id', TELEGRAM_CHAT_ID);
                        formData.append('caption', `${fileObj.productName} - ${fileObj.name}`);
                        formData.append('document', fileObj.blob, fileObj.name);

                        try {
                            const fileResp = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`, {
                                method: 'POST',
                                body: formData
                            });

                            const fileJson = await fileResp.json();
                            if (fileJson.ok) {
                                logToLocalStorage(`–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${fileObj.name}`);
                            } else {
                                logToLocalStorage(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ ${fileObj.name}: ${fileJson.description}`);
                            }
                        } catch (fileError) {
                            logToLocalStorage(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ ${fileObj.name}: ${fileError.message}`);
                        }
                    }
                }

                // 3. –ù–û–í–û–ï: –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ IndexedDB
                await cleanupSentProducts();

                // 4. –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                localStorage.setItem('telegram_sent', 'true');
                localStorage.setItem('telegram_sent_time', new Date().toISOString());
                logToLocalStorage('–ó–ê–ö–ê–ó –£–°–ü–ï–®–ù–û –û–¢–ü–†–ê–í–õ–ï–ù –í TELEGRAM');

                return true;

            } catch (error) {
                logToLocalStorage(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
                return false;
            } finally {
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ñ–ª–∞–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                window.telegramSending = false;
            }
        }
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—á–∏—Å—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    async function cleanupSentProducts() {
        if (!window.TildaCartDB) {
            logToLocalStorage('TildaCartDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—á–∏—Å—Ç–∫–∏');
            return;
        }

        try {
            const db = new TildaCartDB();
            await db.init();

            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏
            const sentProducts = await getCurrentOrderProducts();

            logToLocalStorage(`–û—á–∏—â–∞–µ–º ${sentProducts.length} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤`);

            // –£–¥–∞–ª—è–µ–º –∫–∞–∂–¥—ã–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –ø–æ SKU
            for (const product of sentProducts) {
                if (product.sku) {
                    await db.removeProductBySku(product.sku);
                    logToLocalStorage(`–£–¥–∞–ª–µ–Ω —Ç–æ–≤–∞—Ä —Å SKU: ${product.sku}`);
                }
            }

            logToLocalStorage('–û—á–∏—Å—Ç–∫–∞ IndexedDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

        } catch (error) {
            logToLocalStorage(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ IndexedDB: ${error.message}`);
        }
    }

    // ===== –£–°–ò–õ–ï–ù–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ API ===== //
    function setupEnhancedApiIntercept() {
        logToLocalStorage('üöÄ –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –£–°–ò–õ–ï–ù–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ API');

        // –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –†–ê–°–®–ò–†–ï–ù–ù–´–ô —Å–ø–∏—Å–æ–∫ API endpoints
        const apiEndpoints = [
            // –û—Å–Ω–æ–≤–Ω—ã–µ Tilda API
            'forms.tildaapi.com',
            'forms.tildacdn.com',
            'store.tildaapi.com',
            'tildaapi.com',
            'tilda.cc',

            // –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏
            '/procces/',
            '/payment/',
            '/api/',
            '/order/',
            '/checkout/',
            '/cart/',
            '/submit/',
            '/process/',

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
            'api.tilda',
            '/api/order',
            '/api/checkout',
            '/order/create',
            '/payment/create',
            '/cart/checkout',
            '/store/order',
            '/form/submit'
        ];

        // === –ü–ï–†–ï–•–í–ê–¢ FETCH === //
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            const url = args[0] ? args[0].toString() : '';
            const method = args[1] ? args[1].method : 'GET';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ API endpoints
            const isApiRequest = apiEndpoints.some(endpoint => url.includes(endpoint));

            if (isApiRequest) {
                logToLocalStorage(`üîç –ü–ï–†–ï–•–í–ê–ß–ï–ù FETCH: ${method} ${url}`);

                // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞
                if (args[1] && args[1].body) {
                    const bodyPreview = args[1].body.toString().substring(0, 300);
                    logToLocalStorage(`üì§ –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞: ${bodyPreview}...`);

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
                    try {
                        const formData = new URLSearchParams(args[1].body);
                        const customerData = {
                            name: formData.get('name') || formData.get('Name') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                            email: formData.get('email') || formData.get('Email') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                            phone: formData.get('phone') || formData.get('Phone') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                        };

                        if (customerData.name !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' || customerData.email !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' || customerData.phone !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
                            logToLocalStorage(`üë§ –î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê –∏–∑ –∑–∞–ø—Ä–æ—Å–∞: ${JSON.stringify(customerData)}`);
                            localStorage.setItem('tilda_customer_data', JSON.stringify(customerData));
                        }
                    } catch (error) {
                        logToLocalStorage(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
                    }
                }
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            const response = await originalFetch.apply(this, args);

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç API
            if (isApiRequest) {
                try {
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();

                    logToLocalStorage(`üì• –û–¢–í–ï–¢ –æ—Ç API (${response.status}): ${responseText.substring(0, 300)}...`);

                    // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
                    const responseData = JSON.parse(responseText);

                    // –°–£–ü–ï–†–†–ê–°–®–ò–†–ï–ù–ù–´–ô –ø–æ–∏—Å–∫ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
                    let orderNumber = extractOrderNumber(responseData);

                    if (orderNumber) {
                        logToLocalStorage(`üéØ –ù–ê–ô–î–ï–ù –ù–û–ú–ï–† –ó–ê–ö–ê–ó–ê: ${orderNumber}`);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                        localStorage.setItem('tilda_order_id', orderNumber);
                        localStorage.setItem('order_created_time', Date.now().toString());
                        localStorage.removeItem('telegram_sent');

                        logToLocalStorage('üíæ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É');

                        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
                        setTimeout(() => {
                            logToLocalStorage('üöÄ –ó–ê–ü–£–°–ö–ê–ï–ú –û–¢–ü–†–ê–í–ö–£ –ó–ê–ö–ê–ó–ê');
                            sendOrderToTelegram();
                        }, 1000);
                    }

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –∏–∑ API
                    extractPriceFromResponse(responseData);

                } catch (error) {
                    logToLocalStorage(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
                }
            }

            return response;
        };

        // === –ü–ï–†–ï–•–í–ê–¢ XMLHttpRequest === //
        const originalXHR = window.XMLHttpRequest;
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function (method, url, ...args) {
            this._method = method;
            this._url = url;

            const isApiRequest = apiEndpoints.some(endpoint => url.includes(endpoint));
            if (isApiRequest) {
                logToLocalStorage(`üîç XHR OPEN: ${method} ${url}`);
            }

            return originalOpen.apply(this, [method, url, ...args]);
        };

        XMLHttpRequest.prototype.send = function (data) {
            const isApiRequest = this._url && apiEndpoints.some(endpoint => this._url.includes(endpoint));

            if (this._method === 'POST' && isApiRequest) {
                logToLocalStorage(`üì§ XHR POST: ${this._url}`);

                if (data) {
                    const dataPreview = data.toString().substring(0, 300);
                    logToLocalStorage(`üì§ XHR –¥–∞–Ω–Ω—ã–µ: ${dataPreview}...`);

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                    try {
                        const formData = new URLSearchParams(data);
                        const customerData = {
                            name: formData.get('name') || formData.get('Name') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                            email: formData.get('email') || formData.get('Email') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                            phone: formData.get('phone') || formData.get('Phone') || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                        };

                        if (customerData.name !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' || customerData.email !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' || customerData.phone !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ') {
                            logToLocalStorage(`üë§ XHR –î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê: ${JSON.stringify(customerData)}`);
                            localStorage.setItem('tilda_customer_data', JSON.stringify(customerData));
                        }
                    } catch (error) {
                        logToLocalStorage(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ XHR –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                    }
                }
            }

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            this.addEventListener('load', function () {
                const isApiResponse = this.responseURL && apiEndpoints.some(endpoint => this.responseURL.includes(endpoint));

                if (isApiResponse) {
                    logToLocalStorage(`üì• XHR –û–¢–í–ï–¢ –æ—Ç: ${this.responseURL} (${this.status})`);

                    try {
                        const responseText = this.responseText;
                        logToLocalStorage(`üì• XHR –¥–∞–Ω–Ω—ã–µ: ${responseText.substring(0, 300)}...`);

                        const responseData = JSON.parse(responseText);

                        // –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                        let orderNumber = extractOrderNumber(responseData);

                        if (orderNumber) {
                            logToLocalStorage(`üéØ XHR –ù–ê–ô–î–ï–ù –ù–û–ú–ï–† –ó–ê–ö–ê–ó–ê: ${orderNumber}`);

                            localStorage.setItem('tilda_order_id', orderNumber);
                            localStorage.setItem('order_created_time', Date.now().toString());
                            localStorage.removeItem('telegram_sent');

                            setTimeout(() => {
                                logToLocalStorage('üöÄ XHR: –ó–ê–ü–£–°–ö–ê–ï–ú –û–¢–ü–†–ê–í–ö–£ –ó–ê–ö–ê–ó–ê');
                                sendOrderToTelegram();
                            }, 1000);
                        }

                        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É
                        extractPriceFromResponse(responseData);

                    } catch (error) {
                        logToLocalStorage(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ XHR –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
                    }
                }
            });

            return originalSend.apply(this, arguments);
        };

        logToLocalStorage('‚úÖ –£–°–ò–õ–ï–ù–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ API —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (fetch + XHR)');
    }

    // –§–£–ù–ö–¶–ò–Ø: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ –∏–∑ –ª—é–±–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    function extractOrderNumber(responseData) {
        logToLocalStorage('üîç –ò—â–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –≤ –æ—Ç–≤–µ—Ç–µ...');

        // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
        const orderFields = [
            'results',
            'result',
            'order_id',
            'orderId',
            'orderid',
            'id',
            'order.id',
            'order_number',
            'orderNumber',
            'number',
            'transaction_id',
            'transactionId',
            'payment_id',
            'paymentId'
        ];

        for (const field of orderFields) {
            let value = null;

            // –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–ª–µ
            if (responseData[field]) {
                value = responseData[field];
            }
            // –í–ª–æ–∂–µ–Ω–Ω–æ–µ –ø–æ–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä order.id)
            else if (field.includes('.')) {
                const parts = field.split('.');
                let obj = responseData;
                for (const part of parts) {
                    if (obj && obj[part]) {
                        obj = obj[part];
                    } else {
                        obj = null;
                        break;
                    }
                }
                value = obj;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (value) {
                // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ - –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                if (Array.isArray(value) && value.length > 0) {
                    value = value[0];
                }

                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç - –∏—â–µ–º –ø–æ–ª–µ id
                if (typeof value === 'object' && value.id) {
                    value = value.id;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                if (typeof value === 'string' || typeof value === 'number') {
                    const orderStr = value.toString();
                    if (orderStr.length > 0) {
                        logToLocalStorage(`‚úÖ –ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –≤ –ø–æ–ª–µ "${field}": ${orderStr}`);
                        return orderStr;
                    }
                }
            }
        }

        logToLocalStorage('‚ùå –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ');
        return null;
    }

    // –§–£–ù–ö–¶–ò–Ø: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ API –æ—Ç–≤–µ—Ç–∞
    function extractPriceFromResponse(responseData) {
        const priceFields = ['price', 'amount', 'total', 'sum', 'cost'];

        // –ò—â–µ–º –≤ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
        if (responseData.products && Array.isArray(responseData.products)) {
            responseData.products.forEach(product => {
                for (const field of priceFields) {
                    if (product[field]) {
                        localStorage.setItem('last_api_price', product[field]);
                        logToLocalStorage(`üí∞ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ü–µ–Ω–∞ –∏–∑ API (products.${field}): ${product[field]}`);
                        return;
                    }
                }
            });
        }

        // –ò—â–µ–º –≤ –∫–æ—Ä–Ω–µ–≤–æ–º –æ–±—ä–µ–∫—Ç–µ
        for (const field of priceFields) {
            if (responseData[field]) {
                localStorage.setItem('last_api_price', responseData[field]);
                logToLocalStorage(`üí∞ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ü–µ–Ω–∞ –∏–∑ API (${field}): ${responseData[field]}`);
                return;
            }
        }
    }

    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ä–µ–∑–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ + Polling (–ë–ï–ó –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø)
    function setupEnhancedBackupSystem() {
        logToLocalStorage('‚è∞ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Å–∏–ª–µ–Ω–Ω—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ë–ï–ó –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');

        let isProcessing = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

        // –ë—ã—Å—Ç—Ä—ã–π polling –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        const quickPolling = setInterval(() => {
            const orderId = localStorage.getItem('tilda_order_id');
            const sent = localStorage.getItem('telegram_sent');

            if (orderId && !sent && !isProcessing) {
                isProcessing = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
                logToLocalStorage(`‚ö° QUICK POLLING: –ù–∞–π–¥–µ–Ω –∑–∞–∫–∞–∑ ${orderId}, –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É`);

                sendOrderToTelegram().finally(() => {
                    isProcessing = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    clearInterval(quickPolling); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±—ã—Å—Ç—Ä—ã–π polling –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                });
            }
        }, 2000);

        // –†–µ–∑–µ—Ä–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
        setInterval(() => {
            const orderId = localStorage.getItem('tilda_order_id');
            const orderTime = localStorage.getItem('order_created_time');
            const sent = localStorage.getItem('telegram_sent');

            if (orderId && orderTime && !sent && !isProcessing) {
                const timePassed = Date.now() - parseInt(orderTime);
                if (timePassed > 8000) { // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 8 —Å–µ–∫—É–Ω–¥
                    isProcessing = true;
                    logToLocalStorage(`‚è∞ –†–ï–ó–ï–†–í–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê: –ø—Ä–æ—à–ª–æ ${Math.round(timePassed / 1000)} —Å–µ–∫`);
                    sendOrderToTelegram().finally(() => {
                        isProcessing = false;
                    });
                }
            }
        }, 5000);

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–ª–∞–≥–∞)
        window.addEventListener('beforeunload', (event) => {
            const orderId = localStorage.getItem('tilda_order_id');
            const sent = localStorage.getItem('telegram_sent');

            if (orderId && !sent && !isProcessing) {
                logToLocalStorage('üö® beforeunload: –ü–æ–ø—ã—Ç–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏');

                // –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ sendBeacon
                const customer = getCustomerData();
                const quickMessage = `–≠–ö–°–¢–†–ï–ù–ù–´–ô –ó–ê–ö–ê–ó!\n–ù–æ–º–µ—Ä: ${orderId}\n–ö–ª–∏–µ–Ω—Ç: ${customer.name}\nEmail: ${customer.email}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${customer.phone}\n–í—Ä–µ–º—è: ${new Date().toLocaleString()}`;

                const data = JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: quickMessage
                });

                navigator.sendBeacon(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
                    new Blob([data], { type: 'application/json' }));

                localStorage.setItem('telegram_sent', 'beforeunload');
            }
        });

        logToLocalStorage('‚úÖ –£—Å–∏–ª–µ–Ω–Ω–∞—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ë–ï–ó –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    window.telegramSimple = {
        async sendOrder() {
            logToLocalStorage('üî• –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê —á–µ—Ä–µ–∑ sendOrder()');
            return await sendOrderToTelegram();
        },

        checkCustomerData() {
            const customer = getCustomerData();
            console.log('[TELEGRAM] –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', customer);
            return customer;
        },

        async checkProducts() {
            const products = await getCurrentOrderProducts();
            console.log('[TELEGRAM] –¢–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞:', products);
            return products;
        },

        async checkAllProducts() {
            if (window.TildaCartDB) {
                try {
                    const db = new TildaCartDB();
                    await db.init();
                    const products = await db.getAllProducts();
                    console.log('[TELEGRAM] –í–°–ï —Ç–æ–≤–∞—Ä—ã –≤ IndexedDB:', products);
                    return products;
                } catch (error) {
                    console.error('[TELEGRAM] –û—à–∏–±–∫–∞ IndexedDB:', error);
                    return [];
                }
            } else {
                console.log('[TELEGRAM] TildaCartDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return [];
            }
        },

        checkOrderNumber() {
            const orderNumber = getOrderNumber();
            console.log('[TELEGRAM] –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:', orderNumber);
            return orderNumber;
        },

        setOrderNumber(orderNumber) {
            localStorage.setItem('tilda_order_id', orderNumber);
            localStorage.setItem('order_created_time', Date.now().toString());
            localStorage.removeItem('telegram_sent');
            logToLocalStorage(`üîß –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é: ${orderNumber}`);
        },

        clearStorage() {
            localStorage.removeItem('tilda_order_id');
            localStorage.removeItem('tilda_customer_data');
            localStorage.removeItem('telegram_sent');
            localStorage.removeItem('order_created_time');
            localStorage.removeItem('last_api_price');
            logToLocalStorage('üßπ localStorage –æ—á–∏—â–µ–Ω');
        },

        showLogs() {
            const logs = JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]');
            console.log('=== TELEGRAM DEBUG LOGS ===');
            logs.forEach(log => console.log(log));
            return logs;
        },

        clearLogs() {
            localStorage.removeItem('telegram_debug_logs');
            logToLocalStorage('üßπ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
        },

        checkStatus() {
            const orderId = localStorage.getItem('tilda_order_id');
            const sent = localStorage.getItem('telegram_sent');
            const orderTime = localStorage.getItem('order_created_time');
            const apiPrice = localStorage.getItem('last_api_price');
            const customerData = localStorage.getItem('tilda_customer_data');

            const status = {
                orderId,
                sent: !!sent,
                sentValue: sent,
                orderTime: orderTime ? new Date(parseInt(orderTime)).toLocaleString() : null,
                apiPrice,
                customerData: customerData ? JSON.parse(customerData) : null,
                logsCount: JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]').length
            };

            console.log('=== TELEGRAM STATUS ===', status);
            return status;
        },

        async cleanupIndexedDB() {
            await cleanupSentProducts();
            console.log('[TELEGRAM] IndexedDB –æ—á–∏—â–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ');
        },

        testApiIntercept() {
            logToLocalStorage('üß™ –¢–ï–°–¢: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É API –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞');

            // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            const testUrls = [
                'https://forms.tildaapi.com/procces/',
                'https://store.tildaapi.com/api/',
                'https://forms.tilda.cc/test'
            ];

            testUrls.forEach(url => {
                fetch(url, {
                    method: 'POST',
                    body: 'test=1'
                }).catch(() => {
                    logToLocalStorage(`üß™ –¢–ï–°–¢: –ó–∞–ø—Ä–æ—Å –∫ ${url} –≤—ã–ø–æ–ª–Ω–µ–Ω (–æ—à–∏–±–∫–∞ –æ–∂–∏–¥–∞–µ–º–∞)`);
                });
            });
        },

        async fullDiagnostic() {
            console.log('=== üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM –°–ö–†–ò–ü–¢–ê ===');

            const diagnostic = {
                timestamp: new Date().toISOString(),
                version: '–£–°–ò–õ–ï–ù–ù–´–ô –ü–ï–†–ï–•–í–ê–¢ v2.0',
                orderNumber: this.checkOrderNumber(),
                customerData: this.checkCustomerData(),
                currentProducts: await this.checkProducts(),
                allProducts: await this.checkAllProducts(),
                status: this.checkStatus(),
                interceptStatus: {
                    fetchOverridden: window.fetch.toString().includes('originalFetch'),
                    xhrOverridden: XMLHttpRequest.prototype.send.toString().includes('originalSend')
                },
                logs: this.showLogs()
            };

            console.log('üéØ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê:', diagnostic);
            return diagnostic;
        },

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–∏–º—É–ª—è—Ü–∏—è API –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        simulateOrderResponse(orderNumber = 'TEST123') {
            logToLocalStorage(`üé≠ –°–ò–ú–£–õ–Ø–¶–ò–Ø: API –æ—Ç–≤–µ—Ç —Å –∑–∞–∫–∞–∑–æ–º ${orderNumber}`);

            const mockResponse = {
                results: [orderNumber],
                order_id: orderNumber,
                status: 'success'
            };

            // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–∞
            const extractedOrder = extractOrderNumber(mockResponse);

            if (extractedOrder) {
                localStorage.setItem('tilda_order_id', extractedOrder);
                localStorage.setItem('order_created_time', Date.now().toString());
                localStorage.removeItem('telegram_sent');

                setTimeout(() => {
                    logToLocalStorage('üé≠ –°–ò–ú–£–õ–Ø–¶–ò–Ø: –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É');
                    sendOrderToTelegram();
                }, 1000);
            }
        },

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localStorage
        startMonitoring() {
            logToLocalStorage('üëÅÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localStorage');

            const monitor = setInterval(() => {
                const orderId = localStorage.getItem('tilda_order_id');
                const sent = localStorage.getItem('telegram_sent');

                if (orderId && !sent) {
                    console.log(`üëÅÔ∏è –ú–û–ù–ò–¢–û–†–ò–ù–ì: –ó–∞–∫–∞–∑ ${orderId} –Ω–∞–π–¥–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...`);
                    sendOrderToTelegram();
                    clearInterval(monitor);
                }
            }, 1000);

            setTimeout(() => {
                clearInterval(monitor);
                logToLocalStorage('üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω (—Ç–∞–π–º–∞—É—Ç)');
            }, 60000); // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 1 –º–∏–Ω—É—Ç—É
        }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
    function initializeScript() {
        logToLocalStorage('üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–°–ò–õ–ï–ù–ù–û–ì–û TELEGRAM –°–ö–†–ò–ü–¢–ê');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ XHR –ø–µ—Ä–µ—Ö–≤–∞—Ç
        setupEnhancedApiIntercept();
        setupEnhancedBackupSystem();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–∫–∞–∑ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
        const existingOrder = localStorage.getItem('tilda_order_id');
        const alreadySent = localStorage.getItem('telegram_sent');

        if (existingOrder && !alreadySent) {
            logToLocalStorage(`üîÑ –ù–∞–π–¥–µ–Ω –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑: ${existingOrder}`);

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å polling
            let initProcessing = true;
            setTimeout(() => {
                if (initProcessing && !localStorage.getItem('telegram_sent')) {
                    sendOrderToTelegram().finally(() => {
                        initProcessing = false;
                    });
                }
            }, 2000);

            // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            setTimeout(() => {
                initProcessing = false;
            }, 10000);
        }

        logToLocalStorage('‚úÖ –£–°–ò–õ–ï–ù–ù–´–ô TELEGRAM –°–ö–†–ò–ü–¢ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ë–ï–ó –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è');
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeScript);
    } else {
        initializeScript();
    }

    console.log(`
üöÄ === XHR TELEGRAM –°–ö–†–ò–ü–¢ v3.0 ===
–°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!

üî• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:
‚Ä¢ –¢–æ–ª—å–∫–æ XHR –ø–µ—Ä–µ—Ö–≤–∞—Ç (—É–±—Ä–∞–Ω FETCH)
‚Ä¢ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫
‚Ä¢ –£—Å–∏–ª–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫ –≤ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö
‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localStorage –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

üìã –ö–û–ú–ê–ù–î–´ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:
‚Ä¢ window.telegramSimple.fullDiagnostic() - –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
‚Ä¢ window.telegramSimple.simulateOrderResponse('123') - —Å–∏–º—É–ª—è—Ü–∏—è –∑–∞–∫–∞–∑–∞
‚Ä¢ window.telegramSimple.startMonitoring() - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ localStorage
‚Ä¢ window.telegramSimple.testApiIntercept() - —Ç–µ—Å—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
‚Ä¢ window.telegramSimple.sendOrder() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
‚Ä¢ window.telegramSimple.showLogs() - –≤—Å–µ –ª–æ–≥–∏
‚Ä¢ window.telegramSimple.checkStatus() - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

üéØ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –°–ò–°–¢–ï–ú–´:
‚Ä¢ API –ø–µ—Ä–µ—Ö–≤–∞—Ç: –¢–û–õ–¨–ö–û XMLHttpRequest
‚Ä¢ –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞: 12+ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π –≤ JSON
‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: 8 —Å–µ–∫—É–Ω–¥ –∑–∞–¥–µ—Ä–∂–∫–∏
‚Ä¢ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
‚Ä¢ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: IndexedDB –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:
1. –°–¥–µ–ª–∞–π—Ç–µ –∑–∞–∫–∞–∑
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: window.telegramSimple.fullDiagnostic()
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: window.telegramSimple.showLogs()
4. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö: window.telegramSimple.simulateOrderResponse()
`);
</script>