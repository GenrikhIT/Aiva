<script>
    /**
     * Telegram скрипт с расширенной диагностикой и резервной отправкой
     * РАЗМЕЩЕНИЕ: В FOOTER сайта (перед закрывающим </body>)
     */

    console.log('[TELEGRAM] Скрипт с расширенной диагностикой загружен');

    const TELEGRAM_BOT_TOKEN = '8111231642:AAE6FjAyI5B_zMcokXQ1KPpSU7ZZ2S76DXI';
    const TELEGRAM_CHAT_ID = '481014845';

    // Функция для постоянного логирования (не пропадает при переходах)
    function logToLocalStorage(message) {
        try {
            const logs = JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]');
            const timestamp = new Date().toISOString();
            logs.push(`${timestamp}: ${message}`);

            // Оставляем только последние 50 записей
            if (logs.length > 50) {
                logs.splice(0, logs.length - 50);
            }

            localStorage.setItem('telegram_debug_logs', JSON.stringify(logs));
            console.log('[TELEGRAM DEBUG]', message);
        } catch (error) {
            console.log('[TELEGRAM DEBUG ERROR]', error);
        }
    }

    // Функция для конвертации base64 в Blob
    function base64ToBlob(base64Data, contentType = '') {
        const byteCharacters = atob(base64Data.split(',')[1]);
        const byteNumbers = new Array(byteCharacters.length);

        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: contentType });
    }

    // Функция для получения данных клиента из форм
    function getCustomerData() {
        const customerData = {
            name: 'Не указано',
            email: 'Не указано',
            phone: 'Не указано'
        };

        logToLocalStorage('Начинаем поиск данных клиента');

        // Расширенный поиск по всем возможным селекторам
        const nameSelectors = [
            'input[name="name"]',
            'input[name="Name"]',
            'input[name="firstname"]',
            'input[name="FirstName"]',
            'input[placeholder*="имя"]',
            'input[placeholder*="Имя"]',
            'input[data-tilda-rule="name"]',
            'input[data-field="name"]',
            '.js-tilda-rule input[data-tilda-rule="name"]',
            '.t-input[data-tilda-rule="name"]'
        ];

        const emailSelectors = [
            'input[name="email"]',
            'input[name="Email"]',
            'input[type="email"]',
            'input[data-tilda-rule="email"]',
            'input[data-field="email"]',
            '.js-tilda-rule input[data-tilda-rule="email"]',
            '.t-input[data-tilda-rule="email"]'
        ];

        const phoneSelectors = [
            'input[name="phone"]',
            'input[name="Phone"]',
            'input[name="tel"]',
            'input[type="tel"]',
            'input[data-tilda-rule="phone"]',
            'input[data-field="phone"]',
            '.js-tilda-rule input[data-tilda-rule="phone"]',
            '.t-input[data-tilda-rule="phone"]'
        ];

        // Поиск имени
        for (const selector of nameSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.name = element.value.trim();
                logToLocalStorage(`Имя найдено: ${customerData.name} через ${selector}`);
                break;
            }
        }

        // Поиск email
        for (const selector of emailSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.email = element.value.trim();
                logToLocalStorage(`Email найден: ${customerData.email} через ${selector}`);
                break;
            }
        }

        // Поиск телефона
        for (const selector of phoneSelectors) {
            const element = document.querySelector(selector);
            if (element && element.value && element.value.trim()) {
                customerData.phone = element.value.trim();
                logToLocalStorage(`Телефон найден: ${customerData.phone} через ${selector}`);
                break;
            }
        }

        // Поиск в корзине ST100
        const cartForm = document.querySelector('.js-store-cart-form, .js-cart-form');
        if (cartForm) {
            logToLocalStorage('Найдена форма корзины ST100');

            const cartNameField = cartForm.querySelector('input[name="name"], input[data-tilda-rule="name"]');
            const cartEmailField = cartForm.querySelector('input[name="email"], input[data-tilda-rule="email"]');
            const cartPhoneField = cartForm.querySelector('input[name="phone"], input[data-tilda-rule="phone"]');

            if (cartNameField && cartNameField.value && cartNameField.value.trim()) {
                customerData.name = cartNameField.value.trim();
                logToLocalStorage(`Имя из корзины: ${customerData.name}`);
            }
            if (cartEmailField && cartEmailField.value && cartEmailField.value.trim()) {
                customerData.email = cartEmailField.value.trim();
                logToLocalStorage(`Email из корзины: ${customerData.email}`);
            }
            if (cartPhoneField && cartPhoneField.value && cartPhoneField.value.trim()) {
                customerData.phone = cartPhoneField.value.trim();
                logToLocalStorage(`Телефон из корзины: ${customerData.phone}`);
            }
        }

        // Дополнительная проверка в сохраненных данных
        try {
            const savedCustomerData = localStorage.getItem('tilda_customer_data');
            if (savedCustomerData) {
                const parsed = JSON.parse(savedCustomerData);
                if (parsed.name && parsed.name !== 'Не указано') customerData.name = parsed.name;
                if (parsed.email && parsed.email !== 'Не указано') customerData.email = parsed.email;
                if (parsed.phone && parsed.phone !== 'Не указано') customerData.phone = parsed.phone;
                logToLocalStorage(`Данные из localStorage: ${JSON.stringify(parsed)}`);
            }
        } catch (error) {
            logToLocalStorage(`Ошибка чтения localStorage: ${error.message}`);
        }

        logToLocalStorage(`Итоговые данные клиента: ${JSON.stringify(customerData)}`);
        return customerData;
    }

    // Функция для получения номера заказа из localStorage
    function getOrderNumber() {
        const savedOrderId = localStorage.getItem('tilda_order_id');
        if (savedOrderId) {
            logToLocalStorage(`Найден номер заказа: ${savedOrderId}`);
            return savedOrderId;
        }

        logToLocalStorage('Номер заказа не найден');
        return '';
    }

    // Функция отправки заказа в Telegram
    async function sendOrderToTelegram() {
        logToLocalStorage('НАЧИНАЕМ ОТПРАВКУ ЗАКАЗА В TELEGRAM');

        // Проверяем что не отправляли уже
        const alreadySent = localStorage.getItem('telegram_sent');
        if (alreadySent) {
            logToLocalStorage('Заказ уже отправлен ранее, пропускаем');
            return false;
        }

        // Получаем данные клиента
        const customer = getCustomerData();

        // Получаем номер заказа
        const orderNumber = getOrderNumber();

        let message = 'НОВЫЙ ЗАКАЗ - ОЖИДАЕМ ОПЛАТУ!\n\n';

        // Добавляем номер заказа если есть
        if (orderNumber) {
            message += `Номер заказа: ${orderNumber}\n\n`;
        }

        message += `Клиент: ${customer.name}\n`;
        message += `Email: ${customer.email}\n`;
        message += `Телефон: ${customer.phone}\n`;
        message += `Дата: ${new Date().toLocaleString('ru-RU')}\n\n`;

        let files = [];
        let totalAmount = 0;

        // Получаем товары из IndexedDB
        if (window.TildaCartDB) {
            try {
                const db = new TildaCartDB();
                await db.init();
                const products = await db.getAllProducts();

                logToLocalStorage(`Найдено товаров в IndexedDB: ${products.length}`);

                if (products.length > 0) {
                    message += `Товары в заказе:\n`;
                    products.forEach((product, i) => {
                        message += `\n${i + 1}. ${product.productName || 'Товар'}\n`;
                        if (product.text) {
                            message += `Текст: ${product.text}\n`;
                        }
                        message += `SKU: ${product.sku || 'Не указан'}\n`;
                        message += `Кол-во: 1\n`;

                        // Используем цену из IndexedDB
                        const productPrice = product.price || '0';
                        message += `Цена: ${productPrice} РУБ\n`;

                        // Добавляем к общей сумме
                        const priceNumber = parseFloat(productPrice.toString().replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
                        totalAmount += priceNumber;

                        // Подготавливаем файл
                        if (product.file && product.file.data) {
                            const blob = base64ToBlob(product.file.data, product.file.type);
                            files.push({
                                name: product.file.name || 'file.jpg',
                                blob: blob,
                                productName: product.productName || 'Товар'
                            });
                            message += `К товару прикреплен файл\n`;
                        }
                    });

                    if (files.length > 0) {
                        message += `\nВсего файлов: ${files.length}\n`;
                    }

                    // Используем рассчитанную общую сумму
                    message += `\nОбщая сумма: ${totalAmount} РУБ\n`;
                    message += `СТАТУС: ОЖИДАЕМ ОПЛАТУ\n`;

                    logToLocalStorage(`Рассчитанная сумма: ${totalAmount}`);

                } else {
                    message += `Товары: Не найдены в IndexedDB\n`;
                    logToLocalStorage('Товары не найдены в IndexedDB');
                }
            } catch (error) {
                logToLocalStorage(`Ошибка получения товаров из IndexedDB: ${error.message}`);
                message += `Ошибка получения товаров: ${error.message}\n`;
            }
        } else {
            logToLocalStorage('TildaCartDB недоступен');
            message += `IndexedDB недоступен\n`;
        }

        try {
            logToLocalStorage('Отправляем текстовое сообщение в Telegram');

            // 1. Отправляем текстовое сообщение
            const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: message
                })
            });

            const result = await response.json();
            if (!result.ok) {
                logToLocalStorage(`Ошибка отправки сообщения: ${result.description}`);
                return false;
            }

            logToLocalStorage('Текстовое сообщение отправлено успешно');

            // 2. Отправляем файлы
            if (files.length > 0) {
                logToLocalStorage(`Отправляем ${files.length} файлов`);

                for (let fileObj of files) {
                    const formData = new FormData();
                    formData.append('chat_id', TELEGRAM_CHAT_ID);
                    formData.append('caption', `${fileObj.productName} - ${fileObj.name}`);
                    formData.append('document', fileObj.blob, fileObj.name);

                    try {
                        const fileResp = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument`, {
                            method: 'POST',
                            body: formData
                        });

                        const fileJson = await fileResp.json();
                        if (fileJson.ok) {
                            logToLocalStorage(`Файл отправлен: ${fileObj.name}`);
                        } else {
                            logToLocalStorage(`Ошибка отправки файла ${fileObj.name}: ${fileJson.description}`);
                        }
                    } catch (fileError) {
                        logToLocalStorage(`Сетевая ошибка при отправке файла ${fileObj.name}: ${fileError.message}`);
                    }
                }
            }

            // 3. Помечаем что заказ отправлен
            localStorage.setItem('telegram_sent', 'true');
            localStorage.setItem('telegram_sent_time', new Date().toISOString());
            logToLocalStorage('ЗАКАЗ УСПЕШНО ОТПРАВЛЕН В TELEGRAM');

            return true;

        } catch (error) {
            logToLocalStorage(`Сетевая ошибка отправки: ${error.message}`);
            return false;
        }
    }

    // Функция для перехвата ответов от Tilda API
    function interceptTildaResponse() {
        logToLocalStorage('Устанавливаем перехват API ответов');

        // Перехватываем fetch запросы
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            const response = await originalFetch.apply(this, args);

            // РАСШИРЕННАЯ проверка URL - ловим любые запросы к Tilda
            const url = args[0] ? args[0].toString() : '';

            if (url.includes('tildaapi.com') || url.includes('forms.tilda') || url.includes('.tilda.')) {
                logToLocalStorage(`ПЕРЕХВАЧЕН FETCH запрос: ${url}`);

                // Извлекаем данные из запроса
                const requestData = args[1];
                if (requestData && requestData.body) {
                    logToLocalStorage(`Данные запроса: ${requestData.body.substring(0, 200)}...`);

                    try {
                        // Парсим данные формы
                        const formData = new URLSearchParams(requestData.body);

                        // Сохраняем данные клиента
                        const customerData = {
                            name: formData.get('name') || formData.get('Name') || 'Не указано',
                            email: formData.get('email') || formData.get('Email') || 'Не указано',
                            phone: formData.get('phone') || formData.get('Phone') || 'Не указано'
                        };

                        logToLocalStorage(`Данные клиента из запроса: ${JSON.stringify(customerData)}`);

                        // Сохраняем данные в localStorage
                        localStorage.setItem('tilda_customer_data', JSON.stringify(customerData));

                    } catch (error) {
                        logToLocalStorage(`Ошибка парсинга данных запроса: ${error.message}`);
                    }
                }

                try {
                    // Клонируем ответ для чтения
                    const clonedResponse = response.clone();
                    const responseText = await clonedResponse.text();

                    logToLocalStorage(`Ответ от API: ${responseText.substring(0, 200)}...`);

                    // Парсим JSON ответ
                    const responseData = JSON.parse(responseText);

                    // Проверяем наличие results и извлекаем номер заказа
                    if (responseData.results && responseData.results.length > 0) {
                        const orderNumber = responseData.results[0];
                        logToLocalStorage(`НАЙДЕН НОМЕР ЗАКАЗА: ${orderNumber}`);

                        // Сохраняем номер заказа в localStorage
                        localStorage.setItem('tilda_order_id', orderNumber);
                        localStorage.setItem('order_created_time', Date.now().toString());

                        // Сбрасываем флаг отправки
                        localStorage.removeItem('telegram_sent');

                        logToLocalStorage('Номер заказа сохранен, запускаем отправку через 2 секунды');

                        // СРАЗУ ОТПРАВЛЯЕМ В TELEGRAM
                        setTimeout(() => {
                            logToLocalStorage('ЗАПУСКАЕМ ОТПРАВКУ ЗАКАЗА');
                            sendOrderToTelegram();
                        }, 2000); // Увеличиваем задержку до 2 секунд

                    } else {
                        logToLocalStorage('Номер заказа не найден в ответе');
                    }

                } catch (error) {
                    logToLocalStorage(`Ошибка парсинга ответа: ${error.message}`);
                }
            }

            return response;
        };

        // Также перехватываем XMLHttpRequest
        const originalXHR = window.XMLHttpRequest;
        const originalOpen = XMLHttpRequest.prototype.open;

        XMLHttpRequest.prototype.open = function (method, url, ...args) {
            this._method = method;
            this._url = url;

            if (url.includes('tildaapi.com') || url.includes('forms.tilda') || url.includes('.tilda.')) {
                logToLocalStorage(`ПЕРЕХВАЧЕН XHR OPEN: ${method} ${url}`);
            }

            return originalOpen.apply(this, [method, url, ...args]);
        };

        function newXHR() {
            const xhr = new originalXHR();
            const originalSend = xhr.send;

            xhr.send = function (data) {
                // Перехватываем данные запроса
                if (this._method === 'POST' && this._url &&
                    (this._url.includes('tildaapi.com') || this._url.includes('forms.tilda') || this._url.includes('.tilda.'))) {

                    logToLocalStorage(`XHR POST запрос: ${this._url}`);

                    if (data) {
                        logToLocalStorage(`XHR данные: ${data.substring(0, 200)}...`);

                        try {
                            const formData = new URLSearchParams(data);

                            // Сохраняем данные клиента
                            const customerData = {
                                name: formData.get('name') || formData.get('Name') || 'Не указано',
                                email: formData.get('email') || formData.get('Email') || 'Не указано',
                                phone: formData.get('phone') || formData.get('Phone') || 'Не указано'
                            };

                            logToLocalStorage(`XHR данные клиента: ${JSON.stringify(customerData)}`);
                            localStorage.setItem('tilda_customer_data', JSON.stringify(customerData));

                        } catch (error) {
                            logToLocalStorage(`Ошибка парсинга XHR данных: ${error.message}`);
                        }
                    }
                }

                // Перехватываем ответ
                xhr.addEventListener('load', function () {
                    if (xhr.responseURL &&
                        (xhr.responseURL.includes('tildaapi.com') || xhr.responseURL.includes('forms.tilda') || xhr.responseURL.includes('.tilda.'))) {

                        logToLocalStorage(`XHR ответ от: ${xhr.responseURL}`);

                        try {
                            const responseText = xhr.responseText;
                            logToLocalStorage(`XHR ответ: ${responseText.substring(0, 200)}...`);

                            const responseData = JSON.parse(responseText);

                            if (responseData.results && responseData.results.length > 0) {
                                const orderNumber = responseData.results[0];
                                logToLocalStorage(`XHR НАЙДЕН НОМЕР ЗАКАЗА: ${orderNumber}`);

                                localStorage.setItem('tilda_order_id', orderNumber);
                                localStorage.setItem('order_created_time', Date.now().toString());
                                localStorage.removeItem('telegram_sent');

                                logToLocalStorage('XHR: Номер заказа сохранен, запускаем отправку через 2 секунды');

                                setTimeout(() => {
                                    logToLocalStorage('XHR: ЗАПУСКАЕМ ОТПРАВКУ ЗАКАЗА');
                                    sendOrderToTelegram();
                                }, 2000);
                            }
                        } catch (error) {
                            logToLocalStorage(`Ошибка парсинга XHR ответа: ${error.message}`);
                        }
                    }
                });

                return originalSend.apply(this, arguments);
            };

            return xhr;
        }

        window.XMLHttpRequest = newXHR;
        logToLocalStorage('Перехват API установлен (fetch + XHR)');
    }

    // Резервная система отправки по таймеру
    function setupBackupTimer() {
        logToLocalStorage('Устанавливаем резервный таймер');

        setInterval(() => {
            const orderId = localStorage.getItem('tilda_order_id');
            const orderTime = localStorage.getItem('order_created_time');
            const sent = localStorage.getItem('telegram_sent');

            if (orderId && orderTime && !sent) {
                const timePassed = Date.now() - parseInt(orderTime);
                if (timePassed > 15000) { // 15 секунд прошло
                    logToLocalStorage(`РЕЗЕРВНАЯ ОТПРАВКА: прошло ${Math.round(timePassed / 1000)} секунд`);
                    sendOrderToTelegram();
                }
            }
        }, 5000); // Проверяем каждые 5 секунд
    }

    // Глобальные функции для тестирования
    window.telegramSimple = {
        async sendOrder() {
            logToLocalStorage('ПРИНУДИТЕЛЬНАЯ ОТПРАВКА через sendOrder()');
            return await sendOrderToTelegram();
        },

        checkCustomerData() {
            const customer = getCustomerData();
            console.log('[TELEGRAM] Данные клиента:', customer);
            return customer;
        },

        async checkProducts() {
            if (window.TildaCartDB) {
                try {
                    const db = new TildaCartDB();
                    await db.init();
                    const products = await db.getAllProducts();
                    console.log('[TELEGRAM] Товары:', products);
                    return products;
                } catch (error) {
                    console.error('[TELEGRAM] Ошибка IndexedDB:', error);
                    return [];
                }
            } else {
                console.log('[TELEGRAM] TildaCartDB недоступен');
                return [];
            }
        },

        checkOrderNumber() {
            const orderNumber = getOrderNumber();
            console.log('[TELEGRAM] Номер заказа:', orderNumber);
            return orderNumber;
        },

        setOrderNumber(orderNumber) {
            localStorage.setItem('tilda_order_id', orderNumber);
            localStorage.setItem('order_created_time', Date.now().toString());
            localStorage.removeItem('telegram_sent');
            logToLocalStorage(`Номер заказа установлен вручную: ${orderNumber}`);
        },

        clearStorage() {
            localStorage.removeItem('tilda_order_id');
            localStorage.removeItem('tilda_customer_data');
            localStorage.removeItem('telegram_sent');
            localStorage.removeItem('order_created_time');
            logToLocalStorage('localStorage очищен');
        },

        // НОВАЯ ФУНКЦИЯ: Просмотр логов
        showLogs() {
            const logs = JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]');
            console.log('=== TELEGRAM DEBUG LOGS ===');
            logs.forEach(log => console.log(log));
            return logs;
        },

        // НОВАЯ ФУНКЦИЯ: Очистка логов
        clearLogs() {
            localStorage.removeItem('telegram_debug_logs');
            logToLocalStorage('Логи очищены');
        },

        // НОВАЯ ФУНКЦИЯ: Проверка статуса
        checkStatus() {
            const orderId = localStorage.getItem('tilda_order_id');
            const sent = localStorage.getItem('telegram_sent');
            const orderTime = localStorage.getItem('order_created_time');

            const status = {
                orderId,
                sent: !!sent,
                orderTime: orderTime ? new Date(parseInt(orderTime)).toLocaleString() : null,
                logsCount: JSON.parse(localStorage.getItem('telegram_debug_logs') || '[]').length
            };

            console.log('=== TELEGRAM STATUS ===', status);
            return status;
        }
    };

    // Запускаем все при загрузке
    document.addEventListener('DOMContentLoaded', () => {
        logToLocalStorage('DOM загружен, инициализируем скрипт');
        interceptTildaResponse();
        setupBackupTimer();
    });

    // Если документ уже загружен
    if (document.readyState !== 'loading') {
        logToLocalStorage('Документ уже загружен, инициализируем скрипт');
        interceptTildaResponse();
        setupBackupTimer();
    }

    console.log(`
=== TELEGRAM СКРИПТ С РАСШИРЕННОЙ ДИАГНОСТИКОЙ ===
Скрипт успешно загружен!

НОВЫЕ ВОЗМОЖНОСТИ:
• Логирование в localStorage (не пропадает при переходах)
• Расширенный перехват URL (любые tilda API)
• Резервная отправка по таймеру (через 15 секунд)
• Подробная диагностика всех этапов

КОМАНДЫ ДЛЯ ОТЛАДКИ:
• window.telegramSimple.sendOrder() - принудительная отправка
• window.telegramSimple.showLogs() - показать все логи
• window.telegramSimple.checkStatus() - проверить статус заказа
• window.telegramSimple.clearLogs() - очистить логи
• window.telegramSimple.clearStorage() - очистить все данные

ДИАГНОСТИКА ПОСЛЕ ЗАКАЗА:
1. Вернитесь на сайт после оплаты
2. Выполните window.telegramSimple.showLogs()
3. Покажите результат - увидим что происходило
`);
</script>